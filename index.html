<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Documentos Soportes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#f0f4f8">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-apple.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" rel="stylesheet">

  <style>
    :root {
      /* M3 COLOR TOKENS (Base Azul Profesional) */
      --md-sys-color-primary: #006492;
      --md-sys-color-on-primary: #ffffff;
      --md-sys-color-primary-container: #cae6ff;
      --md-sys-color-on-primary-container: #001e30;
      
      --md-sys-color-surface: #f8f9ff;
      --md-sys-color-surface-container: #f0f4f8; /* Fondo App */
      --md-sys-color-surface-container-high: #ffffff; /* Tarjetas/Barra */
      
      --md-sys-color-on-surface: #191c20;
      --md-sys-color-on-surface-variant: #44474e;
      --md-sys-color-outline-variant: #c4c6d0;

      --md-sys-color-error: #ba1a1a;
      --md-sys-color-tertiary: #4a6277;

      /* M3 SHAPES & TYPE */
      --shape-corner-full: 999px;
      --shape-corner-medium: 16px;
      --font-brand: 'Roboto Flex', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background-color: var(--md-sys-color-surface-container);
      color: var(--md-sys-color-on-surface);
      font-family: var(--font-brand);
      padding-bottom: 120px; /* Espacio para el Total Flotante */
    }

    /* HEADER EXPRESSIVE */
    header {
      padding: 40px 20px 20px 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      font-size: 32px;
      font-weight: 400; /* Regular weight es más elegante en M3 Expressive */
      margin: 0;
      letter-spacing: -0.5px;
      color: var(--md-sys-color-on-surface);
    }

    .subtitle {
      font-size: 14px;
      color: var(--md-sys-color-on-surface-variant);
      margin-top: 4px;
      font-weight: 500;
    }

    main {
      padding: 0 16px;
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 0px; /* Gap manejado por los elementos */
    }

    /* SEARCH BAR (Integrated) */
    .search-container {
      background: var(--md-sys-color-surface-container-high);
      border-radius: var(--shape-corner-full);
      height: 56px;
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Sutil elevación */
      margin-bottom: 24px;
      transition: box-shadow 0.2s;
    }

    .search-container:focus-within {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .search-icon {
      font-family: 'Material Symbols Rounded';
      font-size: 24px;
      color: var(--md-sys-color-on-surface-variant);
      margin-right: 12px;
    }

    .search-input {
      border: none;
      background: transparent;
      font-family: var(--font-brand);
      font-size: 16px;
      color: var(--md-sys-color-on-surface);
      flex: 1;
      outline: none;
    }

    /* Botón de acción integrado (Refresh) */
    .action-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--md-sys-color-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .action-btn:active { background-color: var(--md-sys-color-primary-container); }
    .material-symbols-rounded { font-size: 24px; }

    /* M3 TABS (Secciones) */
    .tabs-row {
      display: flex;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      margin-bottom: 16px;
    }

    .tab {
      flex: 1;
      background: none;
      border: none;
      padding: 14px 0;
      font-family: var(--font-brand);
      font-size: 14px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      position: relative;
      cursor: pointer;
      transition: color 0.2s;
    }

    .tab.active {
      color: var(--md-sys-color-primary);
    }

    /* Indicador animado de la pestaña activa */
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 25%; /* Estilo centrado */
      width: 50%;
      height: 3px;
      background-color: var(--md-sys-color-primary);
      border-top-left-radius: 3px;
      border-top-right-radius: 3px;
    }

    /* TARJETAS DE DATOS */
    .list-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 200px; /* Evita colapso visual */
    }

    .card {
      background: var(--md-sys-color-surface-container-high);
      border-radius: var(--shape-corner-medium);
      padding: 16px 20px;
      /* En M3 las tarjetas planas con borde sutil son muy comunes */
      border: 1px solid transparent; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    
    .card:active {
      transform: scale(0.98);
      background-color: #fcfcff;
    }

    .card-row-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .tercero-nombre {
      font-size: 16px;
      font-weight: 600;
      color: var(--md-sys-color-on-surface);
      line-height: 1.3;
      max-width: 65%;
    }

    .valor-moneda {
      font-size: 16px;
      font-weight: 700;
      color: var(--md-sys-color-primary);
      letter-spacing: 0.2px;
    }

    .card-row-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
    }

    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 11px;
    }
    .badge-vencido { background: #ffdad6; color: #410002; }
    .badge-ok { background: #e7f2fa; color: #004a77; }

    /* LOADER */
    .loader-container {
      display: flex;
      justify-content: center;
      padding: 40px;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--md-sys-color-surface-container-high);
      border-top-color: var(--md-sys-color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* TOTAL FLOTANTE (M3 Style) */
    .total-fab {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1c1e; /* Casi negro, alto contraste como tu imagen */
      color: white;
      padding: 12px 24px;
      border-radius: var(--shape-corner-full);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 20px;
      z-index: 100;
      min-width: 280px;
      justify-content: space-between;
      animation: slideUp 0.4s cubic-bezier(0.2, 0, 0, 1);
    }
    
    @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }

    /* Empty State */
    .empty-state { text-align: center; padding: 40px; color: var(--md-sys-color-on-surface-variant); }
  </style>
</head>
<body>

  <header>
    <h1>Documentos Soportes</h1>
    <div class="subtitle">Consulta de saldos</div>
  </header>

  <main>
    <div class="search-container">
      <span class="material-symbols-rounded search-icon">search</span>
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar proveedor o NIT..." onkeyup="aplicarFiltrosLocales()">
      
      <button class="action-btn" onclick="cargarDatosServidor()" title="Actualizar datos">
        <span class="material-symbols-rounded">refresh</span>
      </button>
    </div>

    <div class="tabs-row">
      <button class="tab active" onclick="cambiarSeccion('1', this)">Todos</button>
      <button class="tab" onclick="cambiarSeccion('2', this)">Vencidos</button>
      <button class="tab" onclick="cambiarSeccion('3', this)">Corrientes</button>
    </div>

    <div id="loader" class="loader-container"><div class="spinner"></div></div>
    <div id="listaResultados" class="list-container"></div>

  </main>

  <div class="total-fab" id="totalFab" style="display: none;">
    <span style="font-size: 11px; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; opacity: 0.8;">Total General</span>
    <span id="txtTotal" style="font-size: 18px; font-weight: 700;">$ 0</span>
  </div>

  <script>
    // URL DE TU APPS SCRIPT (/exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbzs73gRIiUT6sBwcValnYGeKhrYwGQTNOpnrqY_W3boIMTb6CX-4_nx8EdNSuNlSxmq/exec";

    // Variables Globales (CACHE)
    let CACHE_DATOS = []; // Aquí guardaremos todo
    let seccionActual = '1'; // 1: Todos, 2: Vencidos, 3: Corrientes

    // Inicialización automática
    window.addEventListener('DOMContentLoaded', () => {
      cargarDatosServidor();
    });

    // 1. CARGA DESDE EL SERVIDOR (Solo una vez o al dar refresh)
    async function cargarDatosServidor() {
      const loader = document.getElementById('loader');
      const list = document.getElementById('listaResultados');
      const fab = document.getElementById('totalFab');
      
      loader.style.display = 'flex';
      list.innerHTML = ''; // Limpiar visualmente
      fab.style.display = 'none';

      try {
        // Consultamos SIN filtros para traer todo
        const response = await fetch(`${API_URL}?criterio=&opcion=1`, { redirect: "follow" });
        const res = await response.json();

        if (res.success) {
          CACHE_DATOS = res.data || []; // Guardamos en memoria
          aplicarFiltrosLocales(); // Renderizamos con lo que haya en memoria
        } else {
          list.innerHTML = `<div class="empty-state">Error: ${res.error}</div>`;
        }
      } catch (e) {
        list.innerHTML = `<div class="empty-state">Error de conexión. Verifica tu internet.</div>`;
      } finally {
        loader.style.display = 'none';
      }
    }

    // 2. LÓGICA DE FILTRADO LOCAL (Instantáneo)
    function aplicarFiltrosLocales() {
      const textoBusqueda = document.getElementById('searchInput').value.toLowerCase();
      const list = document.getElementById('listaResultados');
      
      // Filtramos el CACHE
      const datosFiltrados = CACHE_DATOS.filter(item => {
        // Filtro por Texto
        const coincideTexto = item.nombre_tercero.toLowerCase().includes(textoBusqueda) || 
                              String(item.NIT).includes(textoBusqueda);
        
        // Filtro por Sección (Tab)
        let coincideSeccion = true;
        const dias = parseInt(item.dias_vencidos || 0);
        
        if (seccionActual === '2') coincideSeccion = dias > 0; // Vencidos
        if (seccionActual === '3') coincideSeccion = dias <= 0; // Corrientes

        return coincideTexto && coincideSeccion;
      });

      renderizar(datosFiltrados);
    }

    // 3. RENDERIZADO
    function renderizar(datos) {
      const list = document.getElementById('listaResultados');
      const fab = document.getElementById('totalFab');
      const txtTotal = document.getElementById('txtTotal');
      
      list.innerHTML = '';
      
      if (datos.length === 0) {
        list.innerHTML = `<div class="empty-state">No se encontraron documentos.</div>`;
        fab.style.display = 'none';
        return;
      }

      let sumaTotal = 0;

      datos.forEach(item => {
        sumaTotal += parseFloat(item.valor || 0);
        const dias = parseInt(item.dias_vencidos || 0);
        const esVencido = dias > 0;

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-row-top">
            <div class="tercero-nombre">${item.nombre_tercero}</div>
            <div class="valor-moneda">${formatearMoneda(item.valor)}</div>
          </div>
          <div class="card-row-bottom">
            <div>
              <span style="display:block; margin-bottom:2px">NIT: ${item.NIT}</span>
              <span>${formatearFecha(item.fecha_docto)} • ${item.docto_causacion}</span>
            </div>
            ${esVencido 
              ? `<div class="badge badge-vencido">${dias} días</div>` 
              : `<div class="badge badge-ok">Al día</div>`}
          </div>
        `;
        list.appendChild(card);
      });

      txtTotal.innerText = formatearMoneda(sumaTotal);
      fab.style.display = 'flex';
    }

    // UX: Cambio de Pestañas
    function cambiarSeccion(opcion, btn) {
      // Update UI Tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      // Update Logic
      seccionActual = opcion;
      aplicarFiltrosLocales();
    }

    // Helpers
    const formatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
    function formatearMoneda(val) { return formatter.format(val); }
    
    function formatearFecha(dateStr) {
      if (!dateStr) return "";
      let s = String(dateStr);
      if (s.length === 8 && !s.includes('-')) {
        return `${s.substring(6,8)}/${s.substring(4,6)}/${s.substring(0,4)}`;
      }
      return s.split('T')[0];
    }
  </script>
</body>
</html>

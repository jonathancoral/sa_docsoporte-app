<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Documentos Soporte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#f0f4f8">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-apple.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" rel="stylesheet">

  <style>
    :root {
      /* M3 COLOR TOKENS */
      --md-sys-color-primary: #006492;
      --md-sys-color-on-primary: #ffffff;
      --md-sys-color-primary-container: #cae6ff;
      --md-sys-color-on-primary-container: #001e30;
      
      --md-sys-color-surface: #f8f9ff;
      --md-sys-color-surface-container: #f0f4f8; 
      --md-sys-color-surface-container-high: #ffffff; 
      
      --md-sys-color-on-surface: #191c20;
      --md-sys-color-on-surface-variant: #44474e;
      --md-sys-color-outline-variant: #c4c6d0;

      --md-sys-color-error-container: #ffdad6;
      --md-sys-color-on-error-container: #410002;
      
      /* SHAPES */
      --shape-corner-full: 999px;
      --shape-corner-medium: 16px;
      --shape-corner-large: 28px;
      --font-brand: 'Roboto Flex', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    /* CORRECCIÓN 1: OCULTAR SCROLLBAR (Nativo & Webkit) */
        html, body {
          scrollbar-width: none;       /* Firefox */
          -ms-overflow-style: none;    /* IE y Edge */
          overflow-x: hidden;          /* Evita scroll horizontal accidental */
        }
        
        /* Ocultar en Chrome, Safari y Opera */
        html::-webkit-scrollbar, body::-webkit-scrollbar {
          display: none;
        }
    
        /* ESTILOS DEL BODY */
        body {
          margin: 0;
          background-color: var(--md-sys-color-surface-container);
          color: var(--md-sys-color-on-surface);
          font-family: var(--font-brand);
          padding-bottom: 120px;
        }

    /* CORRECCIÓN 2: ALINEACIÓN VERTICAL DEL HEADER */
    header {
      padding: 32px 20px 20px 20px;
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center; /* Centrado verticalmente */
      gap: 16px;
    }

    .header-text h1 {
      font-size: 28px;
      font-weight: 400;
      margin: 0;
      letter-spacing: -0.5px;
      color: var(--md-sys-color-on-surface);
      line-height: 1.2;
    }

    .header-text .subtitle {
      font-size: 14px;
      color: var(--md-sys-color-on-surface-variant);
      margin-top: 4px;
      font-weight: 500;
    }

    /* PERFIL M3 (Chip style) */
    .profile-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: var(--md-sys-color-surface-container-high);
      padding: 4px 12px 4px 4px;
      border-radius: var(--shape-corner-full);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      flex-shrink: 0;
    }

    .profile-chip:active { transform: scale(0.96); }

    .avatar {
      width: 32px; height: 32px;
      background-color: var(--md-sys-color-primary);
      color: white;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-weight: 600; font-size: 14px;
    }

    .profile-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface);
      display: none;
    }
    
    @media (min-width: 360px) { .profile-name { display: block; } }

    main {
      padding: 0 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* SEARCH BAR */
    .search-container {
      background: var(--md-sys-color-surface-container-high);
      border-radius: var(--shape-corner-full);
      height: 56px;
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 24px;
      transition: box-shadow 0.2s;
    }
    .search-container:focus-within { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    
    .search-input {
      border: none; background: transparent;
      font-family: var(--font-brand); font-size: 16px;
      color: var(--md-sys-color-on-surface);
      flex: 1; outline: none;
    }

    .action-btn {
      width: 48px; height: 48px; border-radius: 50%;
      border: none; background: transparent;
      color: var(--md-sys-color-primary); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    /* TABS */
    .tabs-row {
      display: flex;
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      margin-bottom: 16px;
    }
    .tab {
      flex: 1; background: none; border: none; padding: 14px 0;
      font-family: var(--font-brand); font-size: 14px; font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      position: relative; cursor: pointer;
    }
    .tab.active { color: var(--md-sys-color-primary); }
    .tab.active::after {
      content: ''; position: absolute; bottom: 0; left: 25%;
      width: 50%; height: 3px;
      background-color: var(--md-sys-color-primary);
      border-radius: 3px 3px 0 0;
    }

    /* CARDS */
    .list-container { display: flex; flex-direction: column; gap: 12px; }
    
    .card {
      background: var(--md-sys-color-surface-container-high);
      border-radius: var(--shape-corner-medium);
      padding: 16px 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      cursor: pointer; position: relative; overflow: hidden;
    }
    .card:active { background-color: #f2f6fa; }

    .card-row-top { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .tercero-nombre { font-size: 16px; font-weight: 600; line-height: 1.3; max-width: 65%; }
    .valor-moneda { font-size: 16px; font-weight: 700; color: var(--md-sys-color-primary); }
    
    .card-row-bottom {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 12px; color: var(--md-sys-color-on-surface-variant);
    }
    
    .badge { padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 11px; }
    .badge-vencido { background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); }
    .badge-ok { background: #e7f2fa; color: #004a77; }

    /* DETALLES */
    .details {
      display: none;
      padding-top: 16px; margin-top: 12px;
      border-top: 1px dashed var(--md-sys-color-outline-variant);
      font-size: 14px; color: var(--md-sys-color-on-surface-variant);
      line-height: 1.5;
      animation: expand 0.3s ease;
    }
    @keyframes expand { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    /* MODAL ACERCA DE */
    .dialog-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none; justify-content: center; align-items: center;
      animation: fadeIn 0.2s;
    }
    
    .dialog-card {
      background: var(--md-sys-color-surface-container-high);
      padding: 32px; border-radius: var(--shape-corner-large);
      width: 90%; max-width: 320px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transform: scale(0.9); animation: popIn 0.3s forwards cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes fadeIn { from{opacity:0}to{opacity:1} }
    @keyframes popIn { to{transform:scale(1)} }

    .dialog-avatar {
      width: 64px; height: 64px; margin: 0 auto 16px;
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
      border-radius: 50%; font-size: 28px; font-weight: 600;
      display: flex; align-items: center; justify-content: center;
    }

    .dialog-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .dialog-email { font-size: 14px; color: var(--md-sys-color-primary); margin-bottom: 24px; text-decoration: none; display: block; word-break: break-all; }
    
    .dialog-btn {
      background: var(--md-sys-color-primary); color: white;
      border: none; padding: 10px 24px; border-radius: var(--shape-corner-full);
      font-weight: 500; font-size: 14px; cursor: pointer;
    }

    /* LOADER */
    .loader-container { display: flex; justify-content: center; padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: var(--md-sys-color-primary); border-radius: 50%; animation: spin 1s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* CORRECCIÓN 3: TOTAL FLOTANTE REDISEÑADO (Gris M3) */
    .total-fab {
      position: fixed; 
      bottom: 24px; 
      left: 50%; 
      transform: translateX(-50%);
      background: #313033; /* Gris Oscuro M3 */
      color: #f4eff4; 
      padding: 12px 24px 12px 20px;
      border-radius: 999px; /* Cápsula */
      box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3);
      display: flex; 
      align-items: center; 
      gap: 16px; 
      z-index: 100; 
    }

    .label-total {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.5px;
      color: rgba(244, 239, 244, 0.7);
      text-transform: uppercase;
    }

    .valor-total-fab {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      font-family: 'Roboto Flex', sans-serif;
    }
  </style>
</head>
<body>

  <header>
    <div class="header-text">
      <h1>Documentos Soporte</h1>
      <div class="subtitle">Consulta de saldos</div>
    </div>
    
    <div class="profile-chip" onclick="abrirModal()">
      <div class="avatar">J</div>
      <div class="profile-name">Jonathan Coral</div>
    </div>
  </header>

  <main>
    <div class="search-container">
      <span class="material-symbols-rounded" style="color:#44474e; margin-right:12px">search</span>
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar proveedor o NIT..." onkeyup="aplicarFiltrosLocales()">
      <button class="action-btn" onclick="cargarDatosServidor()"><span class="material-symbols-rounded">refresh</span></button>
    </div>

    <div class="tabs-row">
      <button class="tab active" onclick="cambiarSeccion('1', this)">Todos</button>
      <button class="tab" onclick="cambiarSeccion('2', this)">Vencidos</button>
      <button class="tab" onclick="cambiarSeccion('3', this)">Corrientes</button>
    </div>

    <div id="loader" class="loader-container"><div class="spinner"></div></div>
    <div id="listaResultados" class="list-container"></div>
  </main>

  <div class="total-fab" id="totalFab" style="display: none;">
    <span class="label-total">Total</span>
    <span id="txtTotal" class="valor-total-fab">$ 0</span>
  </div>

  <div id="aboutModal" class="dialog-overlay" onclick="cerrarModal(event)">
    <div class="dialog-card">
      <div class="dialog-avatar">J</div>
      <div class="dialog-title">Desarrollado por<br>Jonathan Coral</div>
      <a href="mailto:jonathancoral@unicomfacauca.edu.co" class="dialog-email">jonathancoral@unicomfacauca.edu.co</a>
      <button class="dialog-btn" onclick="document.getElementById('aboutModal').style.display='none'">Cerrar</button>
    </div>
  </div>

  <script>
    // RECUERDA: PEGA AQUÍ LA URL "EXEC" DE TU APPS SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbzs73gRIiUT6sBwcValnYGeKhrYwGQTNOpnrqY_W3boIMTb6CX-4_nx8EdNSuNlSxmq/exec";

    let CACHE_DATOS = [];
    let seccionActual = '1'; 

    window.addEventListener('DOMContentLoaded', () => {
      cargarDatosServidor();
    });

    // --- LÓGICA DEL MODAL ---
    function abrirModal() {
      document.getElementById('aboutModal').style.display = 'flex';
    }
    
    function cerrarModal(e) {
      if (e.target.className === 'dialog-overlay') {
        e.target.style.display = 'none';
      }
    }

    // --- DATOS ---
    async function cargarDatosServidor() {
      const loader = document.getElementById('loader');
      const list = document.getElementById('listaResultados');
      const fab = document.getElementById('totalFab');
      
      loader.style.display = 'flex';
      list.innerHTML = ''; 
      fab.style.display = 'none';

      try {
        const response = await fetch(`${API_URL}?criterio=&opcion=1`, { redirect: "follow" });
        const res = await response.json();

        if (res.success) {
          CACHE_DATOS = res.data || [];
          aplicarFiltrosLocales(); 
        } else {
          list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--md-sys-color-error-container)">${res.error}</div>`;
        }
      } catch (e) {
        list.innerHTML = `<div style="text-align:center; padding:30px">Error de conexión</div>`;
      } finally {
        loader.style.display = 'none';
      }
    }

    function aplicarFiltrosLocales() {
      const textoBusqueda = document.getElementById('searchInput').value.toLowerCase();
      
      const datosFiltrados = CACHE_DATOS.filter(item => {
        const coincideTexto = (item.nombre_tercero || "").toLowerCase().includes(textoBusqueda) || 
                              String(item.NIT).includes(textoBusqueda);
        
        const dias = parseInt(item.dias_vencidos || 0);
        let coincideSeccion = true;
        
        if (seccionActual === '2') coincideSeccion = dias > 0;
        if (seccionActual === '3') coincideSeccion = dias <= 0;

        return coincideTexto && coincideSeccion;
      });

      renderizar(datosFiltrados);
    }

    function renderizar(datos) {
      const list = document.getElementById('listaResultados');
      const fab = document.getElementById('totalFab');
      const txtTotal = document.getElementById('txtTotal');
      
      list.innerHTML = '';
      
      if (datos.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:40px; color:#888;">No se encontraron registros.</div>`;
        fab.style.display = 'none';
        return;
      }

      let sumaTotal = 0;

      datos.forEach(item => {
        sumaTotal += parseFloat(item.valor || 0);
        const dias = parseInt(item.dias_vencidos || 0);
        const esVencido = dias > 0;

        const card = document.createElement('div');
        card.className = 'card';
        
        card.onclick = (e) => {
          const detallesDiv = card.querySelector('.details');
          if (detallesDiv.style.display === 'block') {
            detallesDiv.style.display = 'none';
          } else {
            detallesDiv.style.display = 'block';
          }
        };

        card.innerHTML = `
          <div class="card-row-top">
            <div class="tercero-nombre">${item.nombre_tercero}</div>
            <div class="valor-moneda">${formatearMoneda(item.valor)}</div>
          </div>
          <div class="card-row-bottom">
            <div>
              <span style="display:block; margin-bottom:2px">NIT: ${item.NIT}</span>
              <span>${formatearFecha(item.fecha_docto)} • ${item.docto_causacion}</span>
            </div>
            ${esVencido 
              ? `<div class="badge badge-vencido">${dias} días</div>` 
              : `<div class="badge badge-ok">Al día</div>`}
          </div>
          
          <div class="details">
             <strong style="color:var(--md-sys-color-primary)">Observación:</strong><br>
             ${item.nota_saldo_abierto || 'Sin notas registradas.'}
          </div>
        `;
        list.appendChild(card);
      });

      txtTotal.innerText = formatearMoneda(sumaTotal);
      fab.style.display = 'flex';
    }

    function cambiarSeccion(opcion, btn) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      seccionActual = opcion;
      aplicarFiltrosLocales();
    }

    const formatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
    function formatearMoneda(val) { return formatter.format(val); }
    
    function formatearFecha(dateStr) {
      if (!dateStr) return "";
      let s = String(dateStr);
      if (s.length === 8 && !s.includes('-')) {
        return `${s.substring(6,8)}/${s.substring(4,6)}/${s.substring(0,4)}`;
      }
      return s.split('T')[0];
    }
  </script>
</body>
</html>
